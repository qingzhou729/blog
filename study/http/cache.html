<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一、缓存 | 青舟</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/blog/egg.png">
    <meta name="description" content="青舟博客">
    
    <link rel="preload" href="/blog/assets/css/0.styles.17cdd368.css" as="style"><link rel="preload" href="/blog/assets/js/app.83b4c05d.js" as="script"><link rel="preload" href="/blog/assets/js/2.5d61fb1c.js" as="script"><link rel="preload" href="/blog/assets/js/9.37462cfa.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.5bb46d5f.js"><link rel="prefetch" href="/blog/assets/js/11.959b65e0.js"><link rel="prefetch" href="/blog/assets/js/12.7d54ddcc.js"><link rel="prefetch" href="/blog/assets/js/13.9420802b.js"><link rel="prefetch" href="/blog/assets/js/14.6b7e2240.js"><link rel="prefetch" href="/blog/assets/js/15.986177a3.js"><link rel="prefetch" href="/blog/assets/js/16.6a22dc6a.js"><link rel="prefetch" href="/blog/assets/js/17.5aad8bcc.js"><link rel="prefetch" href="/blog/assets/js/18.5827c998.js"><link rel="prefetch" href="/blog/assets/js/3.16698265.js"><link rel="prefetch" href="/blog/assets/js/4.78753901.js"><link rel="prefetch" href="/blog/assets/js/5.6834f8b2.js"><link rel="prefetch" href="/blog/assets/js/6.623fab2c.js"><link rel="prefetch" href="/blog/assets/js/7.722080a8.js"><link rel="prefetch" href="/blog/assets/js/8.8a4c2374.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.17cdd368.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/egg.png" alt="青舟" class="logo"> <span class="site-name can-hide">青舟</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/study/prepare/" class="nav-link">
  博客汇总
</a></div><div class="nav-item"><a href="https://github.com/qingzhou729/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/study/prepare/" class="nav-link">
  博客汇总
</a></div><div class="nav-item"><a href="https://github.com/qingzhou729/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>准备工作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/prepare/" class="sidebar-link">Introduction</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React.js</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/react/" class="sidebar-link">Introduction</a></li><li><a href="/blog/study/react/2.html" class="sidebar-link">介绍一下</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue.js 2.x版本</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/vue2/" class="sidebar-link">Introduction</a></li><li><a href="/blog/study/vue2/observer.html" class="sidebar-link">响应式原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/webpack/" class="sidebar-link">Introduction</a></li><li><a href="/blog/study/webpack/tapable.html" class="sidebar-link">tapable</a></li><li><a href="/blog/study/webpack/hmr.html" class="sidebar-link">热更新</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>HTTP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/http/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/blog/study/http/cache.html" aria-current="page" class="active sidebar-link">缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/study/http/cache.html#一、缓存" class="sidebar-link">一、缓存</a></li><li class="sidebar-sub-header"><a href="/blog/study/http/cache.html#二、浏览器缓存" class="sidebar-link">二、浏览器缓存</a></li><li class="sidebar-sub-header"><a href="/blog/study/http/cache.html#三、新鲜度检测" class="sidebar-link">三、新鲜度检测</a></li><li class="sidebar-sub-header"><a href="/blog/study/http/cache.html#四、node实战" class="sidebar-link">四、Node实战</a></li><li class="sidebar-sub-header"><a href="/blog/study/http/cache.html#五、新鲜度检测-koa源码解读" class="sidebar-link">五、新鲜度检测（Koa源码解读）</a></li><li class="sidebar-sub-header"><a href="/blog/study/http/cache.html#六、总结" class="sidebar-link">六、总结</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="一、缓存"><a href="#一、缓存" class="header-anchor">#</a> 一、缓存</h2> <p>缓存技术一直一来在<code>WEB</code>技术体系中扮演非常重要角色，是快速且有效地提升性能的手段。
<img src="http://yukiyang.com/blog/075718.jpg" alt="">
如上图，在网页展示出来的过程中，各个层面都可以进行缓存。</p> <p>之前在学习缓存的过程中，一直没有实践过，有些概念经常会忘记。
今天主要通过Node实践的方式学习<strong>浏览器缓存</strong>，顺便分析一下<code>Koa</code>处理缓存的源码。</p> <h2 id="二、浏览器缓存"><a href="#二、浏览器缓存" class="header-anchor">#</a> 二、浏览器缓存</h2> <p>首先我们看一下浏览器请求缓存过程。
<img src="http://yukiyang.com/blog/075736.jpg" alt=""></p> <ul><li><p>发出请求后，会先在本地查找缓存。</p></li> <li><p>查到有缓存，要判断缓存是否<strong>新鲜</strong>（是否过期）。</p></li> <li><p>没有过期，直接返回给客户端。</p></li> <li><p>如果缓存过期了，就要再次去服务器请求最新的资源，返回给客户端，并重新进行缓存。</p></li></ul> <h2 id="三、新鲜度检测"><a href="#三、新鲜度检测" class="header-anchor">#</a> 三、新鲜度检测</h2> <p>可能很多同学看其他博客，提到都是“强缓存/协商缓存”等说法，这个我会放到后面讲。
上图中<strong>新鲜</strong>一词比较少见，来自《HTTP权威指南》。</p> <p>因为<code>HTTP</code>会将资源缓存一段时间，在这个时间内，这个缓存就是“新鲜的”。
所以检查缓存是否过期就被称为，<strong>新鲜度检测</strong>。</p> <p>那么接下来就通过<code>Node</code>来实战一下，看看：</p> <ol><li>浏览器是如何进行缓存的？</li> <li>如何进行新鲜度检测？</li></ol> <h2 id="四、node实战"><a href="#四、node实战" class="header-anchor">#</a> 四、Node实战</h2> <p>上述提到缓存一段时间，那么HTTP提供了通用首部字段（就是请求报文和响应报文都能用上的字段），来控制缓存时间。</p> <h3 id="_1-pragma-expires介绍"><a href="#_1-pragma-expires介绍" class="header-anchor">#</a> 1. Pragma/Expires介绍</h3> <p><img src="http://yukiyang.com/blog/075749.jpg" alt=""></p> <blockquote><p>Pragma 是HTTP/1.0标准中定义的一个header属性，请求中包含Pragma的效果跟在头信息中定义Cache-Control: no-cache相同，但是HTTP的响应头没有明确定义这个属性，所以它不能拿来完全替代HTTP/1.1中定义的Cache-control头。通常定义Pragma以向后兼容基于HTTP/1.0的客户端。</p></blockquote> <p><code>Expires</code>会返回一个绝对时间，如果请求时间在<code>Expires</code>指定的时间之前，就能命中缓存。但是因为客户端可以修改本地时间，会和和服务器时间不一致，容易出现差错，不推荐使用。
<img src="http://yukiyang.com/blog/075758.jpg" alt=""></p> <h3 id="_2-cache-control介绍"><a href="#_2-cache-control介绍" class="header-anchor">#</a> 2. Cache-Control介绍</h3> <p><img src="http://yukiyang.com/blog/075859.jpg" alt=""></p> <p><code>Cache-Control</code>是现在常见的缓存方式，上述字段很多，初学者可以只看<code>max-age</code>，避免混乱，也是最有意义的属性。</p> <p><img src="http://yukiyang.com/blog/075910.jpg" alt=""> <code>Cache-Control</code>描述的是一个相对时间，在进行缓存命中的时候，都是利用客户端时间进行判断，所以相比较<code>Expires</code>，<code>Cache-Control</code>的缓存管理更有效，安全一些。</p> <h3 id="_3-cache-control实战"><a href="#_3-cache-control实战" class="header-anchor">#</a> 3. Cache-Control实战</h3> <p>通过<code>Koa</code>框架，简单搭建一个<code>Node</code>服务。并通过<code>koa-static</code>管理静态资源。</p> <p>代码结构参考如下，<code>maxage</code>缓存设置<code>10</code>秒。
<img src="http://yukiyang.com/blog/075925.jpg" alt="">
启动服务，就可以看到自己的页面了~</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code>node index<span class="token punctuation">.</span>js <span class="token comment">// server is starting at port 8001</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="http://yukiyang.com/blog/075941.jpg" alt="">
在代码截图上，可以看到给<code>koa-static</code>传了<code>maxage: 10 * 1000</code>。</p> <p><code>koa-static</code>源码中引入了<code>koa-send</code>库。截取部分<code>koa-send</code>源码，只要传入<code>maxage</code>，就会设置<code>Cache-Control</code>的<code>max-age</code>。为符合前端开发者习惯传入为毫秒，实际上是用秒为单位的。</p> <p><img src="http://yukiyang.com/blog/075952.jpg" alt="">
通过<code>NetWork</code>可以观察到已经成功设置<code>Cache-Control: max-age=10</code> <img src="http://yukiyang.com/blog/080002.jpg" alt=""></p> <p>访问测试如下图：</p> <p><img src="http://yukiyang.com/blog/080109.jpg" alt=""></p> <ol><li><p>在10s内再次请求，可以看到js/css均来自缓存<code>memory cache</code>。</p></li> <li><p>10s后缓存过期，不走缓存，便再次从服务器获取。</p></li></ol> <h3 id="_4-html为何如此特殊"><a href="#_4-html为何如此特殊" class="header-anchor">#</a> 4. HTML为何如此特殊？</h3> <h4 id="_4-1-现象"><a href="#_4-1-现象" class="header-anchor">#</a> 4.1 现象</h4> <p>经过上面的实验可以看出，在<code>Js/Css</code>都走本地缓存的时候，<code>HTML</code>是依旧从服务端获取的。
<img src="http://yukiyang.com/blog/080121.jpg" alt="">
查看请求信息之后，发现请求头中默认加上了<code>Cache-Control: max-age=0</code>。
<img src="http://yukiyang.com/blog/080134.jpg" alt="">
经过测试，发现如果单独请求<code>Js</code>资源，也会出现此类现象。因此得出结论，这个是浏览器默认加的，应该是为了<strong>保证直接请求的资源最新</strong>。
<img src="http://yukiyang.com/blog/080143.jpg" alt=""></p> <h4 id="_4-2-原因"><a href="#_4-2-原因" class="header-anchor">#</a> 4.2 原因</h4> <p>针对<code>request</code>请求，如果有<code>Cache-Control</code>限制，那么缓存系统就会先校验<code>Cache-Control</code>。不符合规则就直接请求服务端，具体规则如下：
<img src="http://yukiyang.com/blog/080158.jpg" alt=""> <img src="http://yukiyang.com/blog/080211.jpg" alt="">
上述来自《HTTP权威指南》。
同理浏览器中<code>Network</code>中的<code>disable-cache</code>也是如此，发出请求时，表示不需要走缓存，一定要服务端最新的。
<img src="http://yukiyang.com/blog/080224.jpg" alt=""> <img src="http://yukiyang.com/blog/080231.jpg" alt=""></p> <h3 id="_5-服务端再验证-新鲜度检测"><a href="#_5-服务端再验证-新鲜度检测" class="header-anchor">#</a> 5. 服务端再验证（新鲜度检测）</h3> <p>上述无论是<code>http1.0</code>还是<code>1.1</code>的方案，都是在本地缓存中存放一段时间。过期后就需要去服务端重新请求一遍。这个也被称之为<strong>强缓存</strong>。</p> <p>但是，<strong>缓存中过期并不意味服务端资源改变</strong>。</p> <p>因此请求发现本地缓存过期，可以去服务端咨询一下，这个资源还新鲜吗？还可以继续使用吗？常见的方法就是携带字段<code>If-Modified-Since</code>和<code>If-None-Match</code>。如果验证资源是新鲜的，没有改变。那只需要返回一个标识，也就是我们常说的<code>304</code>，不需要返回数据，加速请求时间。</p> <p>这个过程就是<strong>新鲜度检测</strong>，那实现这个缓存的方式就是我们常说的<strong>协商缓存</strong>。</p> <p>下面看下Node实战协商缓存。</p> <h3 id="_6-last-modified-和-if-modified-since"><a href="#_6-last-modified-和-if-modified-since" class="header-anchor">#</a> 6. Last-Modified 和 If-Modified-Since</h3> <p>携带<code>If-Modified-Since</code>的前提是，缓存中存储了<code>Last-Modified</code>字段。
每个请求返回时，<code>response</code>中可以携带字段<code>Last-Modified</code>，是服务端资源修改的最后日期。
<img src="http://yukiyang.com/blog/080240.jpg" alt="">
下次发起请求时携带<code>If-Modified-Since</code>就是缓存中的<code>Last-Modified</code>，和服务端资源最后修改时间进行比较，就知道资源是否新鲜了。</p> <h4 id="_6-1-代码验证"><a href="#_6-1-代码验证" class="header-anchor">#</a> 6.1 代码验证</h4> <p>每个请求返回时，<code>response</code>中可以携带字段<code>Last-Modified</code>，是因为我们使用的<code>koa-static</code>会默认给我们的返回头加上<code>Last-Modified</code>。
<img src="http://yukiyang.com/blog/080252.jpg" alt="">
发出的请求也会自动携带<code>If-Modified-Since</code>。
<img src="http://yukiyang.com/blog/080301.jpg" alt="">
但是验证发现，10s后缓存过期，再次发出请求并没有返回304，还是200。
<img src="http://yukiyang.com/blog/080310.jpg" alt="">
原因是需要配置中间件<code>koa-conditional-get</code>。</p> <h4 id="_6-2-koa-conditional-get"><a href="#_6-2-koa-conditional-get" class="header-anchor">#</a> 6.2 koa-conditional-get</h4> <p><img src="http://yukiyang.com/blog/080318.jpg" alt="">
简单看下<code>koa-conditional-get</code>做了什么，让协商缓存生效。
可以看出源码非常简单，判断是否新鲜即可。</p> <p><code>ctx.fresh</code>如何计算，会在后面讲。但很明显是校验了<code>If-Modified-Since</code>和<code>Last-Modified</code>。
<img src="http://yukiyang.com/blog/080348.jpg" alt=""></p> <h4 id="_6-3-last-modified测试"><a href="#_6-3-last-modified测试" class="header-anchor">#</a> 6.3 Last-Modified测试</h4> <ol><li>在10s内请求</li> <li>10s过期后请求
<img src="http://yukiyang.com/blog/080409.jpg" alt=""></li></ol> <p>测试结果，10s内<code>Js/Css</code>走强缓存。<code>HTML</code>由于请求默认加<code>max-age</code>为0，走协商缓存返回304，不需要返回数据，<code>Size</code>由484B降至163B。
<img src="http://yukiyang.com/blog/080425.jpg" alt="">
10s后<code>Js/Css</code>缓存到期，全部走协商缓存，由于<code>Last-Modified</code>一直没有改变，均返回304，不需要返回数据，<code>Size</code>降至163B。
返回304后，会重置<code>max-age</code>，10s内请求无需请求服务器，依然是强缓存。</p> <ol start="3"><li>修改Js内容
<img src="http://yukiyang.com/blog/080517.jpg" alt=""> <img src="http://yukiyang.com/blog/080501.jpg" alt=""></li></ol> <p>修改<code>Js</code>内容测试结果，<code>Css</code>没有修改依旧返回304。<code>Js</code>修改导致<code>Last-Modified</code>大于请求中的<code>If-Modified-Since</code>，资源不够新鲜，返回200并返回最新数据。</p> <h4 id="_6-4-总结"><a href="#_6-4-总结" class="header-anchor">#</a> 6.4 总结</h4> <p><code>Last-Modified</code>工作流程如下：
<img src="http://yukiyang.com/blog/080545.jpg" alt=""></p> <p>一般来说，在没有调整服务器时间和篡改客户端缓存的情况下，这两个<code>header</code>配合起来管理协商缓存是非常可靠的，但是有时候也会服务器上资源其实有变化，但是最后修改时间却没有变化的情况，而这种问题又很不容易被定位出来，而当这种情况出现的时候，就会影响协商缓存的可靠性。所以就有了另外一对<code>header</code>来管理协商缓存，这对header就是【<code>ETag</code>、<code>If-None-Match</code>】</p> <h3 id="_7-etag-和-if-none-match"><a href="#_7-etag-和-if-none-match" class="header-anchor">#</a> 7. ETag 和 If-None-Match</h3> <h4 id="_7-1-etag"><a href="#_7-1-etag" class="header-anchor">#</a> 7.1 ETag</h4> <p>这个<code>header</code>是服务器根据当前请求的资源生成的一个唯一标识，这个唯一标识是一个字符串，只要资源有变化这个串就不同，所以能很好的补充<code>Last-Modified</code>的问题。
避免干扰，可以注释<code>Last-modified</code>逻辑。
<img src="http://yukiyang.com/blog/080604.jpg" alt=""> <code>ETag</code>的验证也非常简单，只需要再加入一个中间件<code>koa-etag</code>，重启服务测试。
<img src="http://yukiyang.com/blog/080612.jpg" alt=""></p> <h4 id="_7-2-etag实践"><a href="#_7-2-etag实践" class="header-anchor">#</a> 7.2 ETag实践</h4> <p>发出请求，<code>response</code>已有<code>Etag</code>：
<img src="http://yukiyang.com/blog/080621.jpg" alt="">
下一次请求也会携带<code>If-None-Match</code>为缓存中的<code>Etag</code>值：
<img src="http://yukiyang.com/blog/080628.jpg" alt=""></p> <p>修改<code>Js</code>资源测试，结果如下：
<img src="http://yukiyang.com/blog/080636.jpg" alt="">
修改<code>Js</code>资源测试后，导致<code>Etag</code>改变。服务端再验证资源不新鲜，<code>Js</code>资源重新获取，返回200。
<img src="http://yukiyang.com/blog/080645.jpg" alt=""> <code>Css</code>没有修改，<code>Etag</code>没变返回304。
<img src="http://yukiyang.com/blog/080652.jpg" alt=""></p> <p><code>Etag</code>整体流程和<code>Last-Modified</code>保持一致。</p> <h4 id="_7-3-koa-etag源码解析"><a href="#_7-3-koa-etag源码解析" class="header-anchor">#</a> 7.3 koa-etag源码解析</h4> <p><code>koa</code>的<code>etag</code>生成主要2个方法，具体的可以直接去看源码。</p> <p>（1）根据文件的修改时间和文件大小生成</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">stattag</span> <span class="token punctuation">(</span><span class="token parameter">stat</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> mtime <span class="token operator">=</span> stat<span class="token punctuation">.</span>mtime<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> size <span class="token operator">=</span> stat<span class="token punctuation">.</span>size<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token string">'&quot;'</span> <span class="token operator">+</span> size <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> mtime <span class="token operator">+</span> <span class="token string">'&quot;'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>（2）使用<code>crypto</code>库加密生成</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">entitytag</span> <span class="token punctuation">(</span><span class="token parameter">entity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// fast-path empty</span>
    <span class="token keyword">return</span> <span class="token string">'&quot;0-2jmj7l5rSw0yVb/vlWAYkK/YBwk&quot;'</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// compute hash of entity</span>
  <span class="token keyword">var</span> hash <span class="token operator">=</span> crypto
    <span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha1'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span>

  <span class="token comment">// compute length of entity</span>
  <span class="token keyword">var</span> len <span class="token operator">=</span> <span class="token keyword">typeof</span> entity <span class="token operator">===</span> <span class="token string">'string'</span>
    <span class="token operator">?</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> entity<span class="token punctuation">.</span>length

  <span class="token keyword">return</span> <span class="token string">'&quot;'</span> <span class="token operator">+</span> len<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'-'</span> <span class="token operator">+</span> hash <span class="token operator">+</span> <span class="token string">'&quot;'</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h2 id="五、新鲜度检测-koa源码解读"><a href="#五、新鲜度检测-koa源码解读" class="header-anchor">#</a> 五、新鲜度检测（Koa源码解读）</h2> <h3 id="_1-koa-conditional-get"><a href="#_1-koa-conditional-get" class="header-anchor">#</a> 1. koa-conditional-get</h3> <p>在前面看到<code>koa-conditional-get</code>可以让协商缓存生效，原因是对资源新鲜度做了304返回的处理。
<img src="http://yukiyang.com/blog/080700.jpg" alt="">
那么重点来看下<code>ctx.fresh</code>是如何处理的？</p> <h3 id="_2-koa"><a href="#_2-koa" class="header-anchor">#</a> 2. koa</h3> <p>可以看到Koa在request中的<code>fresh</code>方法如下：
<img src="http://yukiyang.com/blog/080712.jpg" alt="">
状态码200-300之间以及304调用<code>fresh</code>方法，判断该请求的资源是否新鲜。</p> <h3 id="_3-fresh方法源码解读"><a href="#_3-fresh方法源码解读" class="header-anchor">#</a> 3. fresh方法源码解读</h3> <p>只保留核心代码，可以自行去看<code>fresh</code>的源码。</p> <div class="language-javaSCript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token constant">CACHE_CONTROL_NO_CACHE_REGEXP</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?:^|,)\s*?no-cache\s*?(?:,|$)</span><span class="token regex-delimiter">/</span></span>

<span class="token keyword">function</span> <span class="token function">fresh</span> <span class="token punctuation">(</span><span class="token parameter">reqHeaders<span class="token punctuation">,</span> resHeaders</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 1. 如果这2个字段，一个都没有，不需要校验</span>
  <span class="token keyword">var</span> modifiedSince <span class="token operator">=</span> reqHeaders<span class="token punctuation">[</span><span class="token string">'if-modified-since'</span><span class="token punctuation">]</span>
  <span class="token keyword">var</span> noneMatch <span class="token operator">=</span> reqHeaders<span class="token punctuation">[</span><span class="token string">'if-none-match'</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>modifiedSince <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>noneMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'not fresh'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 2. 给端对端测试用的，因为浏览器的Cache-Control: no-cache请求</span>
  <span class="token comment">//    是不会带if条件的 不会走到这个逻辑</span>
  <span class="token keyword">var</span> cacheControl <span class="token operator">=</span> reqHeaders<span class="token punctuation">[</span><span class="token string">'cache-control'</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheControl <span class="token operator">&amp;&amp;</span> <span class="token constant">CACHE_CONTROL_NO_CACHE_REGEXP</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>cacheControl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 3. 比较 etag和if-none-match</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>noneMatch <span class="token operator">&amp;&amp;</span> noneMatch <span class="token operator">!==</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> etag <span class="token operator">=</span> resHeaders<span class="token punctuation">[</span><span class="token string">'etag'</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>etag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 部分代码</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">===</span> etag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 4. 比较if-modified-since和last-modified</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiedSince<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> lastModified <span class="token operator">=</span> resHeaders<span class="token punctuation">[</span><span class="token string">'last-modified'</span><span class="token punctuation">]</span>
    <span class="token keyword">var</span> modifiedStale <span class="token operator">=</span> <span class="token operator">!</span>lastModified <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">parseHttpDate</span><span class="token punctuation">(</span>lastModified<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">parseHttpDate</span><span class="token punctuation">(</span>modifiedSince<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiedStale<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p><code>fresh</code>的代码判断逻辑总结如下，满足3种条件之一，<code>fresh</code>为<code>true</code>。</p> <p><img src="http://yukiyang.com/blog/080724.jpg" alt=""></p> <h2 id="六、总结"><a href="#六、总结" class="header-anchor">#</a> 六、总结</h2> <p>浏览器缓存整体流程如下：
<img src="http://yukiyang.com/blog/080733.jpg" alt=""></p> <ol><li>发出请求后，会先在本地查找缓存。</li> <li>没有缓存去服务端请求最新的资源，返回给客户端（200），并重新进行缓存。</li> <li>查到有缓存，要判断缓存本地是否过期(<code>max-age</code>等)。</li> <li>没有过期，直接返回给客户端（200 <code>from cache</code>）。</li> <li>如果缓存过期了，看是否有配置协商缓存（<code>etag/last-modified</code>），去服务端再验证该资源是否更新，本地缓存是否可以继续使用。</li> <li>如果发现资源可用，返回304，告知客户端可以继续使用缓存，并根据<code>max-age</code>等更新缓存时间。不需要返回数据，加速请求时间。</li> <li>如果服务端再验证失败，请求最新的资源，返回给客户端（200），并重新进行缓存。</li></ol> <p>我们常说的强缓存，其实就是直接在本地缓存获取，也就是<code>Cache-Control: max-age</code>等配置，不需要和服务端沟通。</p> <p>而协商缓存是在强缓存的基础上，配置<code>etag或last-modified</code>等参数。本地缓存失效后，去服务端进行新鲜度检测。可以避免每次本地缓存过期后都返回最新的数据，造成请求缓慢。</p> <h1 id="七、参考资料"><a href="#七、参考资料" class="header-anchor">#</a> 七、参考资料</h1> <ul><li><a href="https://juejin.im/post/6844903672556552205" target="_blank" rel="noopener noreferrer">前端优化：浏览器缓存技术介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.im/post/6844903763665240072" target="_blank" rel="noopener noreferrer">浏览器缓存<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>书籍《HTTP权威指南》</li></ul> <p>本文的源码分析围绕<code>koa</code>，不代表其他服务框架。对这块知识不了解建议实践一下。写错的地方，接受批评指正~</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">lastUpdate:</span> <span class="time">1/6/2021, 4:10:52 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/study/http/" class="prev router-link-active">
        Introduction
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.83b4c05d.js" defer></script><script src="/blog/assets/js/2.5d61fb1c.js" defer></script><script src="/blog/assets/js/9.37462cfa.js" defer></script>
  </body>
</html>
