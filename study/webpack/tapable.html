<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>青舟</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/blog/egg.png">
    <meta name="description" content="青舟博客">
    
    <link rel="preload" href="/blog/assets/css/0.styles.17cdd368.css" as="style"><link rel="preload" href="/blog/assets/js/app.83b4c05d.js" as="script"><link rel="preload" href="/blog/assets/js/2.5d61fb1c.js" as="script"><link rel="preload" href="/blog/assets/js/18.5827c998.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.5bb46d5f.js"><link rel="prefetch" href="/blog/assets/js/11.959b65e0.js"><link rel="prefetch" href="/blog/assets/js/12.7d54ddcc.js"><link rel="prefetch" href="/blog/assets/js/13.9420802b.js"><link rel="prefetch" href="/blog/assets/js/14.6b7e2240.js"><link rel="prefetch" href="/blog/assets/js/15.986177a3.js"><link rel="prefetch" href="/blog/assets/js/16.6a22dc6a.js"><link rel="prefetch" href="/blog/assets/js/17.5aad8bcc.js"><link rel="prefetch" href="/blog/assets/js/3.16698265.js"><link rel="prefetch" href="/blog/assets/js/4.78753901.js"><link rel="prefetch" href="/blog/assets/js/5.6834f8b2.js"><link rel="prefetch" href="/blog/assets/js/6.623fab2c.js"><link rel="prefetch" href="/blog/assets/js/7.722080a8.js"><link rel="prefetch" href="/blog/assets/js/8.8a4c2374.js"><link rel="prefetch" href="/blog/assets/js/9.37462cfa.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.17cdd368.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/egg.png" alt="青舟" class="logo"> <span class="site-name can-hide">青舟</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/study/prepare/" class="nav-link">
  博客汇总
</a></div><div class="nav-item"><a href="https://github.com/qingzhou729/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/study/prepare/" class="nav-link">
  博客汇总
</a></div><div class="nav-item"><a href="https://github.com/qingzhou729/blog" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>准备工作</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/prepare/" class="sidebar-link">Introduction</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>React.js</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/react/" class="sidebar-link">Introduction</a></li><li><a href="/blog/study/react/2.html" class="sidebar-link">介绍一下</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue.js 2.x版本</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/vue2/" class="sidebar-link">Introduction</a></li><li><a href="/blog/study/vue2/observer.html" class="sidebar-link">响应式原理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>webpack</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/webpack/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/blog/study/webpack/tapable.html" aria-current="page" class="active sidebar-link">tapable</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/study/webpack/tapable.html#一、tapable" class="sidebar-link">一、Tapable</a></li><li class="sidebar-sub-header"><a href="/blog/study/webpack/tapable.html#二、tapable钩子介绍" class="sidebar-link">二、tapable钩子介绍</a></li><li class="sidebar-sub-header"><a href="/blog/study/webpack/tapable.html#三、上述hook使用介绍" class="sidebar-link">三、上述Hook使用介绍</a></li><li class="sidebar-sub-header"><a href="/blog/study/webpack/tapable.html#四、tapable的源码解读" class="sidebar-link">四、Tapable的源码解读</a></li><li class="sidebar-sub-header"><a href="/blog/study/webpack/tapable.html#五、tapable在webpack中的应用" class="sidebar-link">五、Tapable在Webpack中的应用</a></li><li class="sidebar-sub-header"><a href="/blog/study/webpack/tapable.html#六、吐个槽" class="sidebar-link">六、吐个槽</a></li><li class="sidebar-sub-header"><a href="/blog/study/webpack/tapable.html#参考链接" class="sidebar-link">参考链接</a></li></ul></li><li><a href="/blog/study/webpack/hmr.html" class="sidebar-link">热更新</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>HTTP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/http/" class="sidebar-link">Introduction</a></li><li><a href="/blog/study/http/cache.html" class="sidebar-link">缓存</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><code>Webpack</code>的成功之处，不仅在于强大的打包构建能力，也在于它灵活的插件机制。</p> <blockquote><p>Webpack本质上是一种事件流的机制，它的工作流程就是将各个插件串联起来，而实现这一切的核心就是Tapable。</p></blockquote> <p>在学习<code>Webpack</code>的时候，经常可以看到上述介绍。也就是说学<code>Webpack</code>的前提是要学习<code>Tapable</code>。才能更好的学习<code>Webpack</code>原理。</p> <h2 id="一、tapable"><a href="#一、tapable" class="header-anchor">#</a> 一、Tapable</h2> <p>其实<code>tapable</code>的核心思路有点类似于<code>node.js</code>中的<code>events</code>，最基本的<strong>发布/订阅</strong>模式。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> myEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件对应的监听函数</span>
myEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;输出&quot;</span><span class="token punctuation">,</span> params<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件 并传入参数</span>
myEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">,</span> <span class="token string">'学习webpack工作流'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 输出 学习webpack工作流</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="二、tapable钩子介绍"><a href="#二、tapable钩子介绍" class="header-anchor">#</a> 二、tapable钩子介绍</h2> <p>首先，<code>tapable</code>提供的钩子有如下10个。
<img src="http://yukiyang.com/blog/074148.jpg" alt="tapable钩子介绍"></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>
    SyncHook<span class="token punctuation">,</span>
    SyncBailHook<span class="token punctuation">,</span>
    SyncWaterfallHook<span class="token punctuation">,</span>
    SyncLoopHook<span class="token punctuation">,</span>
    AsyncParallelHook<span class="token punctuation">,</span>
    AsyncParallelBailHook<span class="token punctuation">,</span>
    AsyncSeriesHook<span class="token punctuation">,</span>
    AsyncSeriesBailHook<span class="token punctuation">,</span>
    AsyncSeriesLoopHook<span class="token punctuation">,</span>
    AsyncSeriesWaterfallHook
 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>其次，所有钩子的用法简介，如下：（可以简单瞄一眼，就往下看吧）</p> <table><thead><tr><th>序号</th> <th>钩子名称</th> <th>执行方式</th> <th>使用要点</th></tr></thead> <tbody><tr><td>1</td> <td>SyncHook</td> <td>同步串行</td> <td>不关心监听函数的返回值</td></tr> <tr><td>2</td> <td>SyncBailHook</td> <td>同步串行</td> <td>只要监听函数中有一个函数的返回值不为 undefined，则跳过剩下所有的逻辑</td></tr> <tr><td>3</td> <td>SyncWaterfallHook</td> <td>同步串行</td> <td>上一个监听函数的返回值可以传给下一个监听函数</td></tr> <tr><td>4</td> <td>SyncLoopHook</td> <td>同步循环</td> <td>当监听函数被触发的时候，如果该监听函数返回true时则这个监听函数会反复执行，如果返回 undefined 则表示退出循环</td></tr> <tr><td>5</td> <td>AsyncParallelHook</td> <td>异步并发</td> <td>不关心监听函数的返回值</td></tr> <tr><td>6</td> <td>AsyncParallelBailHook</td> <td>异步并发</td> <td>只要监听函数的返回值不为 null，就会忽略后面的监听函数执行，直接跳跃到callAsync等触发函数绑定的回调函数，然后执行这个被绑定的回调函数</td></tr> <tr><td>7</td> <td>AsyncSeriesHook</td> <td>异步串行</td> <td>不关心callback()的参数</td></tr> <tr><td>8</td> <td>AsyncSeriesBailHook</td> <td>异步串行</td> <td>callback()的参数不为null，就会直接执行callAsync等触发函数绑定的回调函数</td></tr> <tr><td>9</td> <td>AsyncSeriesWaterfallHook</td> <td>异步串行</td> <td>上一个监听函数的中的callback(err, data)的第二个参数,可以作为下一个监听函数的参数。</td></tr> <tr><td>10</td> <td>AsyncSeriesLoopHook</td> <td>异步串行</td> <td>可以触发handler循环调用。</td></tr></tbody></table> <h2 id="三、上述hook使用介绍"><a href="#三、上述hook使用介绍" class="header-anchor">#</a> 三、上述Hook使用介绍</h2> <h3 id="_1-1-synchook"><a href="#_1-1-synchook" class="header-anchor">#</a> （1.1）SyncHook</h3> <blockquote><p>同步串行，不关心监听函数的返回值。</p></blockquote> <p>我们先来介绍最简单的<code>SyncHook</code>，其实每个<code>Hook</code>都大同小异，懂一个其他的就非常好懂了。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>SyncHook<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//所有的构造函数都接收一个可选的参数，这个参数是一个字符串的数组。</span>
<span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'param1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// 订阅tap 的第一个参数是用来标识订阅的函数的</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'event 1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'event 2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'event 3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发布的时候触发订阅的函数 同时传入参数</span>
<span class="token function">queue</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 控制台输出</span>
<span class="token comment">/* hello 1
   hello 2
   3
*/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>可以看到，这个钩子订阅的事件都是按顺序同步执行的。</p> <h3 id="_1-2-synchook原理"><a href="#_1-2-synchook原理" class="header-anchor">#</a> （1.2）SyncHook原理</h3> <p>简单模拟下原理。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">SyncHook</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 订阅</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发布</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">tap</span> <span class="token operator">=&gt;</span> <span class="token function">tap</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_2-1-syncbailhook"><a href="#_2-1-syncbailhook" class="header-anchor">#</a> （2.1）SyncBailHook</h3> <p>再来看下<code>SyncBailHook</code>的使用。</p> <blockquote><p>只要监听函数中有一个函数的返回值不为undefined，则跳过剩下所有的逻辑。</p></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'param1'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//所有的构造函数都接收一个可选的参数，这个参数是一个字符串的数组。</span>

<span class="token comment">// 订阅</span>
queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'event 1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// tap 的第一个参数是用来标识订阅的函数的</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'event 2'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">param1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

queue<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'event 3'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 发布</span>
<span class="token function">queue</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token string">'world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 发布的时候触发订阅的函数 同时传入参数</span>

<span class="token comment">// 控制台输出</span>
<span class="token comment">/* hello 1 */</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>可以看到，只要监听函数中有一个函数的返回值不为<code>undefined</code>，则跳过剩下所有的逻辑。</p> <h3 id="_2-2-syncbailhook原理"><a href="#_2-2-syncbailhook原理" class="header-anchor">#</a> （2.2）SyncBailHook原理</h3> <p>简单模拟下原理。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">SyncBailHook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 订阅</span>
    <span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 发布</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> tap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">tap</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="_3-synchook和syncbailhook总结"><a href="#_3-synchook和syncbailhook总结" class="header-anchor">#</a> （3）SyncHook和SyncBailHook总结</h3> <p>上述<code>2</code>种的钩子的执行流程如下图所示：
<img src="http://yukiyang.com/blog/074238.jpg" alt="">
通过这个<code>2</code>个钩子的介绍，可以发现<code>tapable</code>提供了各种各样的<code>hook</code>来帮我们管理事件是如何执行的。</p> <p><code>tapable</code>的核心功能就是控制一系列注册事件之间的执行流控制，比如我注册了三个事件，我可以希望他们是并发的，或者是同步依次执行，又或者其中一个出错后，后面的事件就不执行了，这些功能都可以通过<code>tapable</code>的<code>hook</code>实现。</p> <p>就像起床、上班、吃早饭的关系一样，起床肯定是优先的。但是吃饭和上班就不一定啦。万一要迟到了呢？可能就放弃早饭了！
<img src="http://yukiyang.com/blog/074303.jpg" alt=""></p> <h2 id="四、tapable的源码解读"><a href="#四、tapable的源码解读" class="header-anchor">#</a> 四、Tapable的源码解读</h2> <p>记住重点，核心就是<code>call</code>和<code>tap</code>两个方法。<br>
记住重点，核心就是<code>call</code>和<code>tap</code>两个方法。<br>
记住重点，核心就是<code>call</code>和<code>tap</code>两个方法。</p> <p>那我们来看下<code>tapable</code>源码的<code>SyncHook</code>是如何实现的，如下。还是那句话，看完一个，其他的自然就懂啦。为了理解，源码均为缩减过的，去除了些非核心代码。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// node_modules/tapable/lib/SyncHook.js</span>
<span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 继承基础Hook类</span>
<span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重写Hook的compile方法</span>
    <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 开发者订阅的事件传</span>
        factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 动态生成call方法</span>
    	<span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> SyncHook<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>核心代码非常简单，可以看到<code>SyncHook</code>就是继承了<code>Hook</code>基础类。并重写了<code>compile</code>方法。</p> <p>首先来看下<code>Hook</code>基础类的<code>tap</code>方法。可以看到每次调用<code>tap</code>，就是收集当前<code>hook</code>实例所有订阅的事件到<code>taps</code>数组。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// node_modules/tapable/lib/Hook.js</span>
<span class="token comment">// 订阅</span>
<span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 同步 整理配置项</span>
    options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">,</span> fn<span class="token operator">:</span> fn <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将订阅的事件存储在taps里面</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_insert</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">_insert</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将item 推进 this.taps</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> item<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>然后来看下<code>Hook</code>基础类的<code>call</code>方法是如何实现的。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// node_modules/tapable/lib/Hook.js</span>
<span class="token keyword">class</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span>taps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span>call <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_call<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">// 继承类必须重写compile</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Abstract: should be overriden&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 执行compile生成call方法</span>
    <span class="token function">_createCall</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            taps<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>taps<span class="token punctuation">,</span>
    		<span class="token comment">// ...等参数</span>
    	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 动态生成call方法</span>
<span class="token keyword">function</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">lazyCompileHook</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">// 创造call等函数</span>
    	<span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_createCall</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token comment">// 执行触发call等函数</span>
    	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义_call方法</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperties</span><span class="token punctuation">(</span><span class="token class-name">Hook</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    _call<span class="token operator">:</span> <span class="token punctuation">{</span>
    	value<span class="token operator">:</span> <span class="token function">createCompileDelegate</span><span class="token punctuation">(</span><span class="token string">&quot;call&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    	configurable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    	writable<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>通过上述代码，我们可以发现，<code>call</code>方法究竟是什么，是通过重写的<code>compile</code>方法生成出来的。那我们再看下<code>compile</code>方法究竟做了什么。</p> <p>先来看下<code>SyncHook</code>的全部代码。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// node_modules/tapable/lib/SyncHook.js</span>
<span class="token keyword">const</span> Hook <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./Hook&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HookCodeFactory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./HookCodeFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 继承工厂类</span>
<span class="token keyword">class</span> <span class="token class-name">SyncHookCodeFactory</span> <span class="token keyword">extends</span> <span class="token class-name">HookCodeFactory</span> <span class="token punctuation">{</span>
    <span class="token comment">// call方法个性化定制</span>
    <span class="token function">content</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onError<span class="token punctuation">,</span> onDone<span class="token punctuation">,</span> rethrowIfPossible <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callTapsSeries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">i<span class="token punctuation">,</span> err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">onError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span>
            onDone<span class="token punctuation">,</span>
            rethrowIfPossible
    	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHookCodeFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 继承基础Hook类</span>
<span class="token keyword">class</span> <span class="token class-name">SyncHook</span> <span class="token keyword">extends</span> <span class="token class-name">Hook</span> <span class="token punctuation">{</span>
    <span class="token comment">// 重写Hook的compile方法</span>
    <span class="token function">compile</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 开发者订阅的事件传</span>
        factory<span class="token punctuation">.</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 动态生成call方法</span>
    	<span class="token keyword">return</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> SyncHook<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>可以看到<code>compile</code>主要是执行<code>factory</code>的方法，而<code>factory</code>是<code>SyncHookCodeFactory</code>的实例，继承了<code>HookCodeFactory</code>类，然后<code>factory</code>实例调用了<code>setup</code>方法。</p> <p><code>setup</code>就是将<code>taps</code>中订阅的事件方法统一给了<code>this._x</code>;</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// node_modules/tapable/lib/HookCodeFactory.js</span>
<span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将taps里的所有fn 赋值给 _x</span>
    instance<span class="token punctuation">.</span>_x <span class="token operator">=</span> options<span class="token punctuation">.</span>taps<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> t<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后再看下<code>factory</code>实例调用的<code>create</code>方法。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// node_modules/tapable/lib/HookCodeFactory.js</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fn<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token string">&quot;sync&quot;</span><span class="token operator">:</span>
            fn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>
                <span class="token comment">// 参数</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// 函数体</span>
                <span class="token string">'&quot;use strict&quot;;\n'</span> <span class="token operator">+</span>
                <span class="token comment">// 获取一些需要的变量</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                <span class="token comment">// 事件运行逻辑</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token function-variable function">onError</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">throw </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>err<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                    <span class="token function-variable function">onResult</span><span class="token operator">:</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">return </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
                    resultReturns<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                    <span class="token function-variable function">onDone</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                    rethrowIfPossible<span class="token operator">:</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><code>create</code>会将传进来的所有事件，进行组装。最终生成<code>call</code>方法。
如下就是我们这次的案例最终生成的<code>call</code>方法。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>function anonymous(param1) {
    &quot;use strict&quot;;
    var _context;
    var _x = this._x;
    var _fn0 = _x[0];
    _fn0(param1);
    var _fn1 = _x[1];
    _fn1(param1);
    var _fn2 = _x[2];
    _fn2(param1);
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如果你订阅了<code>5</code>个事件，上述代码就会变成<code>5</code>个函数的依次执行。以及参数必须是创建<code>hook</code>实例就声明好的。否则<code>tap</code>事件传的参数是无用的~</p> <p>以上代码还是简写了很多，大家可以直接去看下源码，非常精简好理解。给作者大大点赞。👍</p> <p>总结一下，核心就是<code>call</code>和<code>tap</code>两个方法。其实还有<code>tapAsync</code>等...但是原理都是一样的。<code>tap</code>收集订阅的事件，触发<code>call</code>方法时根据<code>hook</code>的种类动态生成对应的执行体。如下图，其他<code>hook</code>的实现也是同理。</p> <p><img src="http://yukiyang.com/blog/074342.jpg" alt=""></p> <h2 id="五、tapable在webpack中的应用"><a href="#五、tapable在webpack中的应用" class="header-anchor">#</a> 五、Tapable在Webpack中的应用</h2> <p><code>Webpack</code>的流程可以分为以下三大阶段：</p> <p><img src="http://yukiyang.com/blog/074408.jpg" alt=""></p> <p>执行<code>webpack</code>时，会生成一个<code>compiler</code>实例。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// node_modules/webpack/lib/webpack.js</span>
<span class="token keyword">const</span> Compiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./Compiler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MultiCompiler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./MultiCompiler&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">webpack</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...省略了多余代码...</span>
    <span class="token keyword">let</span> compiler<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid argument: options&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>我们发现<code>Compiler</code>是继承了<code>Tapable</code>的。同时发现<code>webpack</code>的生命周期<code>hooks</code>都是各种各样的钩子。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// node_modules/webpack/lib/Compiler.js</span>
<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Stats&gt;} */</span>
            done<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;stats&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;&gt;} */</span>
            additionalPass<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Compiler&gt;} */</span>
            beforeRun<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compiler&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Compiler&gt;} */</span>
            run<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compiler&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Compilation&gt;} */</span>
            emit<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compilation&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;string, Buffer&gt;} */</span>
            assetEmitted<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">/** @type {AsyncSeriesHook&lt;Compilation&gt;} */</span>
            afterEmit<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compilation&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        
            <span class="token comment">// ....等等等很多 大家看下源码吧.... 不看也没有关系</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>然后在初始化<code>webpack</code>的配置过程中，会循环我们配置的以及<code>webpack</code>默认的所有插件也就是<code>plugin</code>。</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 订阅在options中的所有插件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins <span class="token operator">&amp;&amp;</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> options<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这个过程，会把<code>plugin</code>中所有<code>tap</code>事件收集到每个生命周期的<code>hook</code>中。
最后根据每个<code>hook</code>执行<code>call</code>方法的顺序（也就是生命周期）。就可以把所有<code>plugin</code>执行了。</p> <p>举个例子，下面是我们经常使用的热更新插件代码，它订阅了<code>additionalPass</code>等<code>hook</code>。
<img src="http://yukiyang.com/blog/074446.jpg" alt="">
这也就是<code>webpack</code>它工作流程能将各个插件<code>plugin</code>串联起来的原因，而实现这一切的核心就是<code>Tapable</code>。</p> <h2 id="六、吐个槽"><a href="#六、吐个槽" class="header-anchor">#</a> 六、吐个槽</h2> <p>虽然插件化设计很灵活，我们可以写插件操作<code>webpack</code>的整个生命周期。但是也发现插件化设计带来的一些问题，就是阅读源码非常不好的体验：</p> <p>（1）联系松散。使用<code>tapable</code>钩子类似事件监听模式，虽然能有效解耦，但钩子的注册与调用几乎没有联系。</p> <p>（2）看到源码里一个模块提供了几个钩子，但并不知道，在何时、何地该钩子会被调用，又在何时、何地钩子上被注册了哪些方法。这些以往都是需要通过在代码库中搜索关键词来解决。</p> <p>（3）钩子数量众多。<code>webpack</code>内部的钩子非常多，数量达到了<code>180+</code>，</p> <h2 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h2> <p>本篇文主要是讲原理，理解<code>tapable</code>。其他的钩子的使用，可以看这篇文章。</p> <ul><li><a href="https://juejin.im/post/6844903588112629767" target="_blank" rel="noopener noreferrer">webpack4.0源码分析之Tapable<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">lastUpdate:</span> <span class="time">1/6/2021, 3:51:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/study/webpack/" class="prev router-link-active">
        Introduction
      </a></span> <span class="next"><a href="/blog/study/webpack/hmr.html">
        热更新
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.83b4c05d.js" defer></script><script src="/blog/assets/js/2.5d61fb1c.js" defer></script><script src="/blog/assets/js/18.5827c998.js" defer></script>
  </body>
</html>
